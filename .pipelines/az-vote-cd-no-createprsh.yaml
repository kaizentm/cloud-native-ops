trigger: none

resources:
  pipelines:
  - pipeline: az-vote-ci
    source: 'Azure vote app CI GH'
  repositories:
  - repository: Manifest
    type: git # Set to 'github' for a GitHub repository 
    name: azure-vote-app-deployment
    ref: 'refs/heads/dev'

name: $(Date:yyyyMMdd)$(Rev:.r)

variables:
  - group: az-vote-app-dev
  - name: images_artifact_path
    value: $(Pipeline.Workspace)/az-vote-ci/image_tags
  - name: manifests_artifact_path
    value: $(Pipeline.Workspace)/az-vote-ci/manifests
  - name: utils_artifact_path
    value: $(Pipeline.Workspace)/az-vote-ci/utils
  - name: REPO_URL 
    value: https://csedevops@dev.azure.com/csedevops/GitOps/_git/azure-vote-app-deployment
  - name: OrganizationName
    value: csedevops
  - name: MANIFEST_DIR
    value: $(System.DefaultWorkingDirectory)/azure-vote-app-deployment
  - name: DEPLOY_BRANCH_NAME
    value: deploy/$(Build.BuildNumber)/$(MANIFESTS_BRANCH)
  - name: PROJECT_NAME
    value: GitOps
  - name: REPO_NAME
    value: azure-vote-app-deployment
pool:
  vmImage: ubuntu-latest

  

stages:
  # - stage: "Fetch_the_util_code_temp"
  #   jobs: 
  #   - job: "publish_artifacts"
  #     steps:
  #     - publish: $(System.DefaultWorkingDirectory)/utils
  #       artifact: cd-utils


  - stage: "deploy_dev"
    displayName: "Deploy to Dev"    
    jobs:

    - deployment: Deploy_to_dev
      environment: dev
      strategy:
        runOnce:
          deploy:   
            steps:  
            - template: deployment-template-no-createprsh.yaml         

    # - job: deploy_with_gitops
    #   dependsOn: Deploy_to_dev
    #   displayName: Wait for changes to be applied
    #   pool: server          
    #   variables:
    #     pr_num: $[ dependencies.Deploy_to_dev.outputs['Deploy_to_dev.Create_PR.PR_NUM'] ]
    #     token: $[ dependencies.Deploy_to_dev.outputs['Deploy_to_dev.Create_PR.TOKEN'] ]
    #   condition: ne(variables['pr_num'],'')
    #   steps:   
    #   - template: pr-completion-task-template.yaml

    - job: waitForValidation
      displayName: Wait for external validation
      dependsOn: Deploy_to_dev
      pool: server
      timeoutInMinutes: 4320 # job times out in 3 days
      steps:
      - task: ManualValidation@0
        timeoutInMinutes: 1440 # task times out in 1 day
        inputs:
          notifyUsers: |
            sudivate@microsoft.com          
          instructions: 'Please validate the build configuration and resume'
          onTimeout: 'resume'
 

    - job: rollback_deployment       
      dependsOn: [waitForValidation, Deploy_to_dev]
      condition: succeeded()
      displayName: Rollback Deployment      
      variables:
        pr_num: $[ dependencies.Deploy_to_dev.outputs['Deploy_to_dev.Create_PR.PR_NUM'] ]
        token: $[ dependencies.Deploy_to_dev.outputs['Deploy_to_dev.Create_PR.TOKEN'] ]      
      steps:   
      - template: rollback-pr-revert-template.yaml

    - job: "Automated_testing"
      displayName: Automated testing 
      #dependsOn: deploy_with_gitops
      steps:
      - template: post-deployment-test-template.yaml
            
  - stage: "deploy_stage"
    displayName: "Deploy to Stage"
    variables:
      - group: az-vote-app-stage
    jobs:
    - deployment: Deploy_to_stage
      environment: stage
      strategy:
        runOnce:
          deploy:   
            steps:  
            - template: deployment-template-no-createprsh.yaml                      
            

    # - job: deploy_with_gitops
    #   dependsOn: Deploy_to_stage
    #   displayName: Wait for changes to be applied
    #   pool: server          
    #   variables:
    #     pr_num: $[ dependencies.Deploy_to_stage.outputs['Deploy_to_stage.Create_PR.PR_NUM'] ]
    #     token: $[ dependencies.Deploy_to_stage.outputs['Deploy_to_stage.Create_PR.TOKEN'] ]
    #   condition: ne(variables['pr_num'],'')        
    #   steps:   
    #   - template: pr-completion-task-template.yaml

    - job: waitForValidation
      displayName: Wait for external validation
      dependsOn: Deploy_to_stage
      pool: server
      timeoutInMinutes: 4320 # job times out in 3 days
      steps:
      - task: ManualValidation@0
        timeoutInMinutes: 1440 # task times out in 1 day
        inputs:
          notifyUsers: |
            sudivate@microsoft.com          
          instructions: 'Please validate the build configuration and resume'
          onTimeout: 'resume'

    - job: rollback_deployment      
      dependsOn: [waitForValidation, Deploy_to_stage]
      condition: succeeded()
      displayName: Rollback Deployment      
      variables:
        pr_num: $[ dependencies.Deploy_to_stage.outputs['Deploy_to_stage.Create_PR.PR_NUM'] ]
        token: $[ dependencies.Deploy_to_stage.outputs['Deploy_to_stage.Create_PR.TOKEN'] ]      
      steps:   
      - template: rollback-pr-revert-template.yaml                        

    - job: "Automated_testing"
      displayName: Automated testing 
      # dependsOn: deploy_with_gitops
      steps:
      - template: post-deployment-test-template.yaml                 
           