steps:
- checkout: self
- checkout: Manifest
  persistCredentials: true

- task: Bash@3        
  name: "Generate_Manifests"
  displayName: "Generate Manifests"
  inputs:
    filePath: $(utils_artifact_path)/generate-manifests.sh
    arguments: '$(manifests_artifact_path) gen_manifests'

- script: git config --global user.email $PR_USER_EMAIL & git config --global user.name $PR_USER_NAME
  displayName: Configure Git
  env:
    PR_USER_NAME: "Git Ops"
    PR_USER_EMAIL: "agent@gitops.com"
  workingDirectory: $(MANIFEST_DIR)

- script: |
   echo "Create a new branch $(DEPLOY_BRANCH_NAME)"   
   git checkout -b $(DEPLOY_BRANCH_NAME)
   rm -f .git/index.lock
   mkdir -p $(MANIFESTS_FOLDER)
   cp -r $(Build.SourcesDirectory)/gen_manifests/* $(MANIFESTS_FOLDER)/
   git add -A
   git commit -m "deployment $(Build.BuildNumber)"
   git push --set-upstream origin $(DEPLOY_BRANCH_NAME)
  displayName: Add Generated Manifest to New Branch
  workingDirectory: $(MANIFEST_DIR)

- script: |
   # echo $(PAT) | az devops login --organization https://dev.azure.com/$(OrganizationName)
   az devops configure --defaults organization=https://dev.azure.com/$(OrganizationName) project="$(PROJECT_NAME)" --use-git-aliases true
   pr_response=$(az repos pr create --project $(PROJECT_NAME) --repository $(REPO_NAME) --target-branch $(MANIFESTS_BRANCH) --source-branch $DEPLOY_BRANCH_NAME --title "deployment $(Build.BuildNumber)" --squash -o json)
   export pr_num=$(echo $pr_response | jq '.pullRequestId')
   echo "##vso[task.setvariable variable=PR_NUM;isOutput=true]$pr_num"
   B64_PAT=$(printf ":$(PAT)" | base64) 
   echo "##vso[task.setvariable variable=TOKEN;isOutput=true]$B64_PAT"
  name: "Create_PR" 
  displayName: Create Pull Request
  env:
    AZURE_DEVOPS_EXT_PAT = '$(System.AccessToken)' 